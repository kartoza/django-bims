# Specific configuration for development environment


# Exactly the same as production but for dev env, we expose the port and uses
# different port for the web.
version: '2'
services:

  db:
    volumes:
      - ./pg/postgres_data:/var/lib/postgresql
      - /storage-box/dbbackups:/backups:cached
      - ./sql:/sql
      - ./extra.conf:/settings/extra.conf
    ports:
      - "6543:5432"

  dbbackups:
    volumes:
      - /storage-box/dbbackups:/backups

  uwsgi:
    environment:
      - ADMIN_EMAILS=${ADMIN_EMAILS:-dimas@kartoza.com}
      - APP_NAME=bims
      - ASYNC_SIGNALS_GEONODE=True
      - BROKER_URL=amqp://rabbitmq:5672
      - C_FORCE_ROOT=1
      - CONTACT_US_EMAIL=${ADMIN_EMAILS:-dimas@kartoza.com}
      - ALLOWED_HOSTS=['localhost:63307']
      - DATABASE_HOST=db
      - DATABASE_NAME=${POSTGRES_DBNAME:-gis}
      - DATABASE_PASSWORD=${POSTGRES_PASS:-docker}
      - DATABASE_URL=postgis://${POSTGRES_USER:-docker}:${POSTGRES_PASS:-docker}@db:5432/${POSTGRES_DBNAME:-gis}
      - DATABASE_USERNAME=${POSTGRES_USER:-docker}
      - DJANGO_SETTINGS_MODULE=core.settings.prod_docker
      - GEOCONTEXT_URL=${GEOCONTEXT_URL:-https://geocontext.kartoza.com}
      - GEOSERVER_LOCATION=http://geoserver/geoserver/
      - GEOSERVER_LOCATION_SITE_LAYER=bims:location_site_view
      - GEOSERVER_PUBLIC_LOCATION=http://freshwaterbiodiversity.org/geoserver/
      - MEDIA_ROOT=/home/web/media
      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
      - ROOT_URLCONF=core.urls
      - SITEURL=http://localhost:63307/
      - STATIC_ROOT=/home/web/static/static
      - VIRTUAL_HOST=bims.kartoza.com
      - VIRTUAL_PORT=8080
    volumes:
      - ./static:/home/web/static:rw
      - ./media:/home/web/media:rw

  geoserver:
    ports:
      # for geoserver
      - "63305:8080"
    volumes:
      - ./data_dir:/opt/geoserver/data_dir

  django-runner:
    environment:
      - ADMIN_EMAILS=${ADMIN_EMAILS:-dimas@kartoza.com}
      - APP_NAME=bims
      - ASYNC_SIGNALS_GEONODE=True
      - BROKER_URL=amqp://rabbitmq:5672
      - C_FORCE_ROOT=1
      - CONTACT_US_EMAIL=${ADMIN_EMAILS:-dimas@kartoza.com}
      - ALLOWED_HOSTS=['localhost:63307']
      - DATABASE_HOST=db
      - DATABASE_NAME=${POSTGRES_DBNAME:-gis}
      - DATABASE_PASSWORD=${POSTGRES_PASS:-docker}
      - DATABASE_URL=postgis://${POSTGRES_USER:-docker}:${POSTGRES_PASS:-docker}@db:5432/${POSTGRES_DBNAME:-gis}
      - DATABASE_USERNAME=${POSTGRES_USER:-docker}
      - DJANGO_SETTINGS_MODULE=core.settings.prod_docker
      - CSRF_TRUSTED_ORIGINS=['https://bims-mothership.kartoza.com']
      - GEOCONTEXT_URL=${GEOCONTEXT_URL:-https://geocontext.kartoza.com}
      - GEOSERVER_LOCATION=http://geoserver/geoserver/
      - GEOSERVER_LOCATION_SITE_LAYER=bims:location_site_view
      - GEOSERVER_PUBLIC_LOCATION=http://django-bims.test/geoserver/
      - MEDIA_ROOT=/home/web/media
      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
      - ROOT_URLCONF=core.urls
      - SITEURL=http://localhost:63307/
      - STATIC_ROOT=/home/web/static/static
      - VIRTUAL_HOST=bims.kartoza.com
      - VIRTUAL_PORT=8080
      - PYTHONPATH=/home/web/django_project
    image: bims_uwsgi:latest
    entrypoint: [ "tail", "-f", "/dev/null" ]
    volumes:
      - ./static:/home/web/static:rw
      - ./media:/home/web/media:rw
      - ./logs:/var/log

  web:
    volumes:
      - ./nginx/sites-enabled:/etc/nginx/conf.d:ro
      - ./nginx/html:/etc/nginx/html
      # I dont use volumes_from as I want to use the ro modifier
      - ./logs:/var/log/nginx
      - ./media:/home/web/media:rw
      - ./static:/home/web/static:rw
    ports:
      # for django test server
      - "63307:80"

  worker:
    entrypoint: []
    hostname: worker
    command:
      - celery
      - -A
      - bims.celery:app
      - worker
      - -Q
      - update
      - --autoscale=48,8
      - --max-memory-per-child
      - "4096000"
      - --prefetch-multiplier
      - "1"
      - -l
      - info
    environment:
      - CELERY_CONCURRENCY=48
    healthcheck:
      test: ["CMD-SHELL",
             "celery -A bims.celery:app inspect ping -d celery@$$HOSTNAME || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: "48"      # â‰ˆ 25 % of host
          memory: 64G     # keep plenty free for DB & cache

  geocontextworker:
    entrypoint: []
    hostname: geocontextworker
    command: >
      celery -A bims.celery:app worker
             -Q geocontext
             --autoscale=24,4
             --max-tasks-per-child 400
             --prefetch-multiplier 1
             -l info
    environment:
      - CELERY_CONCURRENCY=24
    healthcheck:
      test: ["CMD-SHELL",
             "celery -A bims.celery:app inspect ping -d celery@$$HOSTNAME || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: "16"
          memory: 24G

  searchworker:
    entrypoint: []
    hostname: searchworker
    command: >
      celery -A bims.celery:app worker
             -Q search
             --autoscale=24,4
             --prefetch-multiplier 1
             -l info
    environment:
      - CELERY_CONCURRENCY=24
    healthcheck:
      test: ["CMD-SHELL",
             "celery -A bims.celery:app inspect ping -d celery@$$HOSTNAME || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: "24"
          memory: 32G

  beat:
    image: bims_uwsgi:latest
    hostname: beat
    entrypoint: [ ]
    command: >
      bash -lc "
        python manage.py migrate django_celery_beat --schema=public --noinput || true;
        python manage.py sync_celery_beat_schedule || true;
        celery -A bims.celery:app beat
          -l info
      "
    environment:
      - DJANGO_SETTINGS_MODULE=core.settings.prod_docker
      - DJANGO_CELERY_BEAT_MAX_LOOP_INTERVAL=30
      - CELERY_TIMEZONE=UTC
      - CELERY_ENABLE_UTC=True
      - BROKER_URL=amqp://rabbitmq:5672
      - DATABASE_URL=postgis://${POSTGRES_USER:-docker}:${POSTGRES_PASS:-docker}@db:5432/${POSTGRES_DBNAME:-gis}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
      - APP_NAME=bims
    depends_on:
      - db
      - rabbitmq
    restart: unless-stopped
    volumes:
      - ./static:/home/web/static:rw
      - ./media:/home/web/media:rw
      - ./logs:/var/log
