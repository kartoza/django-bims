<div id="carouselIndicators" class="carousel slide" data-ride="carousel">
  {% if headers|length > 1 %}
    <ol class="carousel-indicators">
      {% for header in headers %}
        <li data-target="#carouselIndicators" data-slide-to="{{ forloop.counter0 }}" {% if forloop.first %}class="active{% endif %}"></li>
      {% endfor %}
    </ol>
  {% endif %}

  <div class="carousel-inner">
    {% for header in headers %}

      {% if header.title_font_url %}
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="{{ header.title_font_url }}">
      {% endif %}
      {% if header.description_font_url %}
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="{{ header.description_font_url }}">
      {% endif %}

      {% with fit=header.banner_fit|default_if_none:"cover" hmode=header.banner_height_mode|default_if_none:"viewport_vh" hval=header.banner_height_value|default:60 posx=header.banner_position_x|default:"center" posy=header.banner_position_y|default:"center" %}
      <div class="carousel-item {% if forloop.first %}active{% endif %}"
           style="
             /* Whole slide height */
             height:{% if hmode == 'fixed_px' %}{{ hval }}px{% elif hmode == 'viewport_vh' %}{{ hval }}vh{% else %}auto{% endif %};
             min-height: 400px;
             /* Per-slide variables */
             --title-top: {{ header.title_offset_y_percent|default:50 }}%;
             --desc-top-raw: {{ header.description_offset_y_percent|default:60 }}%;
             /* Keep desc target safely within the slide (leave ~8% bottom room) */
             --desc-top: min(var(--desc-top-raw), 92%);
             /* Max font sizes from model */
             --title-max: {{ header.title_font_size|default:45 }}px;
             --desc-max:  {{ header.description_font_size|default:30 }}px;
             /* Sensible minimums so text never disappears */
             --title-min: 22px;
             --desc-min:  16px;
           ">

        <div class="carousel-overlay"
             style="
               background-color: {% firstof header.background_color_overlay header.overlay '#000' %};
               opacity: {% if header.overlay_opacity is not None %}{{ header.overlay_opacity }}{% else %}calc({{ header.background_overlay_opacity|default:0 }} / 100){% endif %};
             ">
        </div>

        <div class="carousel-text-layer">
          <div class="carousel-text-stack"
               style="text-align: {{ header.title_alignment|default:header.text_alignment }};">
            <p class="carousel-title-text"
               style="color: {{ header.text_color|default:'#FFFFFF' }};
                      font-family: {% firstof header.title_font_family 'inherit' %};
                      /* Fluid font size with clamp(min, fluid, max) */
                      font-size: clamp(var(--title-min), calc(var(--title-max) * 0.35 + 2.2vw), var(--title-max));
                      font-weight: {% firstof header.title_font_weight '700' %};
                      letter-spacing: {{ header.title_letter_spacing_em|default:'0.00' }}em;
                      line-height: {{ header.title_line_height_pct|default:110 }}%;
                      {% if header.text_style == 'italic' %}font-style: italic;{% endif %}
                      text-shadow: 2px 2px 5px rgba(0,0,0,0.64);">
              {{ header.title|linebreaksbr }}
            </p>

            <p class="carousel-desc-text"
               style="color: {{ header.text_color|default:'#FFFFFF' }};
                      font-family: {% firstof header.description_font_family header.title_font_family 'inherit' %};
                      font-size: clamp(var(--desc-min),  calc(var(--desc-max) * 0.45 + 1.2vw), var(--desc-max));
                      font-weight: {% firstof header.description_font_weight '400' %};
                      letter-spacing: {{ header.description_letter_spacing_em|default:'0.00' }}em;
                      line-height: {{ header.description_line_height_pct|default:130 }}%;
                      {% if header.text_style == 'italic' %}font-style: italic;{% endif %}
                      text-shadow: 2px 2px 5px rgba(0,0,0,0.62);">
              {% if header.description %}
                {{ header.description|linebreaksbr }}
              {% elif header.paragraph %}
                {{ header.paragraph|linebreaksbr }}
              {% endif %}
            </p>

            {% if app == 'fbis' %}
              <div style="text-align: {{ header.description_alignment|default:header.text_alignment }};">
                {% if not user.is_authenticated %}
                  <a class="btn btn-account btn-l js-scroll-trigger" href="/accounts/login/">Login</a>
                  <a class="btn btn-account btn-l js-scroll-trigger" href="/accounts/signup/">Sign Up</a>
                  <a class="btn btn-account btn-l js-scroll-trigger" href="/map">Explore</a>
                {% else %}
                  <a class="btn btn-account btn-l js-scroll-trigger" href="/map">Explore</a>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>

        <div class="d-block w-100 header-image"
             style="
               {% if header.banner %}background-image: url('{{ header.banner.url }}');{% elif header.file %}background-image: url('uploaded/{{ header.file }}');{% endif %}
               background-repeat: no-repeat;
               background-position: {{ posx }} {{ posy }};
               {% if fit == 'cover' %}background-size: cover;{% elif fit == 'contain' %}background-size: contain;{% elif fit == 'stretch' %}background-size: 100% 100%;{% else %}background-size: auto;{% endif %}
               height: 100%;
             ">
        </div>
      </div>
      {% endwith %}
    {% endfor %}
  </div>
</div>

<style>
  #carouselIndicators { width: 100%; position: relative; overflow-y: hidden; }

  .carousel-indicators li {
    width: 10px; height: 10px; border-radius: 10px; border: 2px solid #fff;
  }

  .header-image { width: 100%; }

  .carousel-overlay {
    position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none;
  }
  .carousel-text-layer { position: absolute; inset: 0; width: 100%; height: 100%; z-index: 2; }

  /* STACK: pin to the smaller of the two “top” values so we can space downwards */
  .carousel-text-stack {
    position: absolute;
    left: 0; right: 0;
    top: min(var(--title-top), var(--desc-top));
    padding: 0 1rem;
  }

  .carousel-title-text,
  .carousel-desc-text {
    margin: 0;
    overflow-wrap: anywhere;
    hyphens: auto;
    max-width: 100%;
  }

  /* Space title/description based on requested tops, but never overlap */
  .carousel-title-text   { margin-top: calc(max(0%, var(--title-top) - var(--desc-top))); }
  .carousel-desc-text    { margin-top: calc(max(0%, var(--desc-top)  - var(--title-top))); }

  /* Extra safety: make fonts shrink a bit more on very narrow screens */
  @media (max-width: 991.98px) {
    .carousel-title-text { font-size: clamp(var(--title-min), 2.8vw, var(--title-max)); }
    .carousel-desc-text  { font-size: clamp(var(--desc-min),  2.0vw, var(--desc-max)); }
  }

  @media (max-width: 575.98px) {
    .carousel-text-stack { padding: 0 .75rem; }
    .carousel-title-text { font-size: clamp(var(--title-min), 5.2vw, var(--title-max)); }
    .carousel-desc-text  { font-size: clamp(var(--desc-min),  3.8vw, var(--desc-max)); }
  }

  #header { margin-top: 55px; }
</style>