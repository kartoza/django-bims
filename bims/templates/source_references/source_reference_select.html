<div style="margin-bottom: 20px;">
    <h4>Source References Select</h4>
    <div class="row">
        <div class="col-3">
            <div class="input-group md-form form-sm form-2 pl-0" style="margin-bottom: 10px;">
                    <input class="form-control my-0 py-1 red-border" type="text" placeholder="Search" aria-label="Search" value="" id="search-input">
                    <div class="input-group-append">
                        <span class="input-group-text red lighten-3" id="basic-text1">
                            <i class="fa fa-search text-grey" aria-hidden="true"></i>
                        </span>
                    </div>
                </div>
            <select id="source-reference-type-select" class="form-control">
                <option value="unpublished">Unpublished</option>
                <option value="database">Database</option>
                <option value="document" selected>Published report or thesis</option>
                <option value="bibliography">Peer-reviewed scientific article</option>
            </select>
        </div>
        <div class="col-9">
            <div id="source-reference-list-container">

            </div>
        </div>
    </div>
</div>

<style>
    #source-reference-list-container {
        max-height: 500px;
        min-height: 500px;
        overflow-y: auto;
    }
</style>

<script type="text/html" id="source-reference-card">
    <div class="card" style="margin-bottom: 10px;">
        <div class="card-body">
            <div class="row">
                <div class="col-12">
                    <p class="reference-type-label"><%= data.reference_type %></p>
                    <h5 class="card-title"><%= data.link_template %></h5>
                    <p style="color: #8a8a8a;font-size: 0.9em;"> Source : <%= data.reference_source %></p></p>
                    <p class="card-text"><i class="fa fa-calendar"
                                            aria-hidden="true"></i> <%= data.year %> <span
                            class="vertical-separator"></span> <i
                            class="fa fa-users" aria-hidden="true"></i> <%= data.authors %>
                        <span class="vertical-separator"></span>
                    </p>
                </div>
            </div>
        </div>
        <div class="card-footer">
            <div class="card-text">
                <div class="float-right">
                    <a href="#" class="badge badge-primary badge-occurrences">Select</a>
                </div>
            </div>
        </div>
    </div>
</script>

<script>
    let currentType = 'document';
    let currentQuery = '';

    function getSourceReferenceList(type = '', query = '') {
        if (type) {
          currentType = type;
        }
        if (query) {
          currentQuery = query
        }
        let $sourceReferenceListContainer = $('#source-reference-list-container');
        $sourceReferenceListContainer.html('Fetching data...');
        $.get(`/api/source-reference-list?type=${currentType}&q=${currentQuery}`, function (data) {
          $sourceReferenceListContainer.html('');
          if (data['results'].length > 0) {
            for (let i = 0; i < data['results'].length; i++) {
              let result = data['results'][i];
              let sourceReferenceCard = _.template($('#source-reference-card').html());
              $sourceReferenceListContainer.append(sourceReferenceCard({
                data: result,
              }));
            }
          } else {
            $sourceReferenceListContainer.html('No data');
          }
        })
    }

    $('#source-reference-type-select').change((e) => {
      let type = $(e.target).val()
      getSourceReferenceList(type);
    })

    $('#search-input').keypress(function (e) {
      if (e.which === 13) {
        getSourceReferenceList('', $(e.target).val());
      }
    })

    $('.input-group-append').click(function (e) {
      let value = $('#search-input').val();
      getSourceReferenceList('', value);
    })

    getSourceReferenceList(currentType);

</script>