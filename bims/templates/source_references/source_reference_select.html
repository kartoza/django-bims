{% load static from staticfiles %}
<link href="{% static "lib/pagination/bs-pagination.min.css" %}" rel="stylesheet"/>
<div style="margin-bottom: 20px;">

   <div class="form-group row  clockpicker-container">
       <label for="start-time"
              class="col-sm-2 col-form-label col-form-label">Selected Source Reference</label>
       <div class="col-sm-10">
           <div class="input-group">
               <textarea class="form-control" id="selected-source-reference" name="source_reference_title" disabled> </textarea>
               <input type="hidden" id="selected-source-reference-id" name="source_reference">
           </div>
       </div>
   </div>

    <h4>Choose Source Reference</h4>
    <hr class="hr-normal"/>
    <div class="row">
        <div class="col-3">
            <div class="input-group md-form form-sm form-2 pl-0" style="margin-bottom: 10px;">
                    <input class="form-control my-0 py-1 red-border" type="text" placeholder="Search" aria-label="Search" value="" id="search-input">
                    <div class="input-group-append">
                        <span class="input-group-text red lighten-3" id="basic-text1">
                            <i class="fa fa-search text-grey" aria-hidden="true"></i>
                        </span>
                    </div>
                </div>
            <select id="source-reference-type-select" class="form-control">
                <option value="unpublished">Unpublished</option>
                <option value="database">Database</option>
                <option value="document" selected>Published report or thesis</option>
                <option value="bibliography">Peer-reviewed scientific article</option>
            </select>
        </div>
        <div class="col-9">
            <div id="source-reference-list-container">
            </div>
            <ul id="pagination" class="pagination"></ul>
        </div>
    </div>
</div>

<style>
    #source-reference-list-container {
        max-height: 500px;
        min-height: 500px;
        overflow-y: auto;
    }
    .select-source-reference {
        cursor: pointer;
    }
</style>

<script src="{% static "lib/pagination/pagination.min.js" %}"></script>
<script type="text/html" id="source-reference-card">
    <div class="card" style="margin-bottom: 10px;">
        <div class="card-body">
            <div class="row">
                <div class="col-12">
                    <p class="reference-type-label"><%= data.reference_type %></p>
                    <h5 class="card-title"><%= data.link_template %></h5>
                    <p style="color: #8a8a8a;font-size: 0.9em;"> Source : <%= data.reference_source %></p></p>
                    <p class="card-text"><i class="fa fa-calendar"
                                            aria-hidden="true"></i> <%= data.year %> <span
                            class="vertical-separator"></span> <i
                            class="fa fa-users" aria-hidden="true"></i> <%= data.authors %>
                        <span class="vertical-separator"></span>
                    </p>
                </div>
            </div>
        </div>
        <div class="card-footer">
            <div class="card-text">
                <div class="float-right">
                    <div class="badge badge-primary select-source-reference" onclick="selectSourceReference(<%= data.id %>)">Select</div>
                </div>
            </div>
        </div>
    </div>
</script>

<script>
    let currentType = 'document';
    let currentQuery = '';
    let selectedSourceReference = null;
    let sourceReferences = {};
    let currentPage = 1;

    function updatePagination(totalEntries) {
       	$('#pagination').pagination({
          // the number of entries
          total: totalEntries,
          // current page
          current: currentPage,
          // the number of entries per page
          length: 20,
          // pagination size
          size: 10,
          // Prev/Next text
          prev: "&lt;",
          next: "&gt;",
          // fired on each click
          click: function (e) {
            currentPage = e.current;
            getSourceReferenceList();
          }
        });
    }

    function getSourceReferenceList() {
        let $sourceReferenceListContainer = $('#source-reference-list-container');
        $sourceReferenceListContainer.html('Fetching data...');
        $.get(`/api/source-reference-list?type=${currentType}&q=${currentQuery}&page=${currentPage}`, function (data) {
          $sourceReferenceListContainer.html('');
          sourceReferences = {};
          updatePagination(data['count']);
          console.log(data);
          if (data['results'].length > 0) {
            for (let i = 0; i < data['results'].length; i++) {
              let result = data['results'][i];
              sourceReferences[result.id] = result;
              let sourceReferenceCard = _.template($('#source-reference-card').html());
              $sourceReferenceListContainer.append(sourceReferenceCard({
                data: result,
              }));
            }
          } else {
            $sourceReferenceListContainer.html('No data');
          }
        })
    }

    $('#source-reference-type-select').change((e) => {
      let type = $(e.target).val();
      currentPage = 1;
      currentType = type;
      getSourceReferenceList();
    })

    $('#search-input').keypress(function (e) {
      if (e.which === 13) {
        currentPage = 1;
        currentQuery = $(e.target).val();
        getSourceReferenceList();
      }
    })

    $('.input-group-append').click(function (e) {
      let value = $('#search-input').val();
      currentPage = 1;
      currentQuery = value;
      getSourceReferenceList();
    })

    function selectSourceReference(sourceReferenceId) {
      selectedSourceReference = sourceReferences[sourceReferenceId];
      $('#selected-source-reference').val(`(${selectedSourceReference.reference_type}) - ${selectedSourceReference.title}`);
      $('#selected-source-reference-id').val(selectedSourceReference.id);
    }

    getSourceReferenceList(currentType);

</script>