import logging
from datetime import datetime

from django.http import JsonResponse
from django.shortcuts import get_object_or_404
from rest_framework.views import APIView

from bims.models import LocationSite
from bims.models.water_temperature import calculate_indicators, \
    WaterTemperature, thermograph_data

logger = logging.getLogger('bims')


def get_all_days_of_year(year):
    from datetime import date, timedelta

    sdate = date(year, 1, 1)  # start date
    edate = date(year, 12, 31)  # end date

    delta = edate - sdate  # as timedelta
    days = []
    for i in range(delta.days + 1):
        day = sdate + timedelta(days=i)
        days.append(day)
    return days


class ThermalDataApiView(APIView):
    """Get thermal data"""

    def get(self, request, *args):
        site_id = request.GET.get('site-id', None)
        year = self.request.GET.get('year', None)
        start_date = self.request.GET.get('startDate', None)
        end_date = self.request.GET.get('endDate', None)
        indicator = {}
        thermograph = {}

        location_site = get_object_or_404(
            LocationSite,
            id=site_id
        )

        if start_date and end_date:
            start_date = datetime.strptime(start_date, '%Y-%m-%d')
            end_date = datetime.strptime(end_date, '%Y-%m-%d')
            water_temperature = WaterTemperature.objects.filter(
                date_time__gte=start_date,
                date_time__lte=end_date
            )
            year = start_date.year
            if water_temperature:
                indicator = calculate_indicators(
                    location_site, year, True, water_temperature)
        else:
            if not year:
                years = list(WaterTemperature.objects.filter(
                    location_site=location_site
                ).values_list('date_time__year', flat=True).distinct(
                    'date_time__year').order_by('date_time__year'))
                year = years[-1]
            else:
                year = int(year.strip())
            indicator = calculate_indicators(
                location_site, year, True)
        if indicator and 'weekly' in indicator:
            thermograph = thermograph_data(indicator['weekly'])
            thermograph['date_time'] = indicator['date_time']
        return JsonResponse(
            {
                "mean_7": [
                    19.592726190476185,
                    19.52413293650793,
                    19.181928571428564,
                    18.735396825396823,
                    18.276178571428566,
                    19.06544047619047,
                    19.262684523809522,
                    19.371845238095233,
                    19.31209523809523,
                    19.2410119047619,
                    19.061476190476185,
                    18.953464285714283,
                    18.749684523809524,
                    18.542755952380954,
                    18.24944246031746,
                    18.092988095238095,
                    18.104011904761904,
                    18.33648214285714,
                    18.586087301587302,
                    18.943190476190473,
                    19.156128968253963,
                    19.385295634920627,
                    19.610027777777777,
                    19.726255952380946,
                    19.62081944444444,
                    19.435553571428564,
                    19.315371031746025,
                    19.31930555555555,
                    19.368273809523807,
                    19.45148214285714,
                    19.515128968253965,
                    19.592726190476185,
                    19.52413293650793,
                    19.181928571428564,
                    18.735396825396823,
                    18.276178571428566,
                    17.875375,
                    17.589287698412697,
                    17.37511111111111,
                    17.186767857142858,
                    17.288714285714285,
                    17.44018849206349,
                    17.555662037037038,
                    17.600672222222222,
                    17.522336805555558,
                    17.422208333333334,
                    17.624694444444444,
                    17.668999999999997
                ],
                "min_7": [
                    17.017285714285713,
                    16.785999999999998,
                    16.62285714285714,
                    16.758714285714284,
                    16.969285714285714,
                    17.849999999999998,
                    18.057285714285715,
                    18.26442857142857,
                    18.186428571428568,
                    18.15585714285714,
                    17.979142857142858,
                    17.836428571428574,
                    17.635714285714283,
                    17.391,
                    17.017285714285713,
                    16.785999999999998,
                    16.62285714285714,
                    16.758714285714284,
                    16.969285714285714,
                    17.312571428571427,
                    17.52,
                    17.727285714285717,
                    17.951714285714285,
                    18.118285714285715,
                    18.101285714285716,
                    17.914428571428573,
                    17.75485714285714,
                    17.768428571428572,
                    17.788857142857143,
                    17.941714285714287,
                    18.098,
                    18.135428571428573,
                    18.06742857142857,
                    17.76114285714286,
                    17.288,
                    16.81157142857143,
                    16.345714285714287,
                    15.965,
                    15.808714285714286,
                    15.71342857142857,
                    15.842857142857143,
                    16.159714285714283,
                    16.355666666666664,
                    16.4916,
                    16.5345,
                    16.455,
                    16.725,
                    17.13
                ],
                "max_7": [
                    20.089714285714287,
                    19.88528571428572,
                    19.579142857142863,
                    19.24614285714286,
                    19.290285714285716,
                    20.245857142857144,
                    20.42957142857143,
                    20.443142857142856,
                    20.364857142857144,
                    20.25614285714286,
                    20.069142857142854,
                    20.014714285714287,
                    19.953428571428567,
                    19.89557142857143,
                    19.79342857142857,
                    19.83771428571429,
                    20.09271428571429,
                    20.528428571428574,
                    20.88957142857143,
                    21.22,
                    21.427857142857142,
                    21.662857142857142,
                    21.88428571428571,
                    21.96957142857143,
                    21.843285714285713,
                    21.686285714285713,
                    21.607857142857142,
                    21.587285714285713,
                    21.638571428571424,
                    21.614714285714285,
                    21.594285714285714,
                    21.62842857142857,
                    21.502428571428574,
                    21.16214285714286,
                    20.777571428571427,
                    20.375714285714285,
                    20.089714285714287,
                    19.88528571428572,
                    19.579142857142863,
                    19.24614285714286,
                    19.290285714285716,
                    19.23942857142857,
                    19.2225,
                    19.122600000000002,
                    18.87175,
                    18.770666666666667,
                    19.1155,
                    18.747
                ],
                "95%_low": [
                    17.69792780134564,
                    17.53081846863035,
                    17.42241413229229,
                    17.42596306247387,
                    17.470132299428624,
                    17.196977425120267,
                    17.374891039986924,
                    17.473353718655467,
                    17.419459374990335,
                    17.355342394312014,
                    17.193401649778465,
                    17.095975194294557,
                    16.912166382242777,
                    16.725517352239326,
                    16.46094934984786,
                    16.31982792190648,
                    16.329771369253343,
                    16.53945891576079,
                    16.764602115847705,
                    17.08670824498533,
                    17.278778207676623,
                    17.485485941399237,
                    17.688193746248523,
                    17.793031255631522,
                    17.69792780134564,
                    17.53081846863035,
                    17.42241413229229,
                    17.42596306247387,
                    17.470132299428624,
                    17.54518599838209,
                    17.60259526835918,
                    17.672587759771798,
                    17.610716824165525,
                    17.30204938223589,
                    16.89927891565804,
                    16.485065252115493,
                    16.123541479382713,
                    15.865491481893567,
                    15.672304760536964,
                    15.50241963825455,
                    15.594375050084865,
                    15.731004387882143,
                    15.835161223313698,
                    15.875760292582344,
                    15.80510195171231,
                    15.714786331752322,
                    15.897428274173048,
                    15.937391769359419
                ],
                "95%_up": [
                    22.277283368029607,
                    22.350176443962187,
                    22.439046551408016,
                    22.360488457759242,
                    21.968570579488507,
                    21.8351597531277,
                    22.061058299531286,
                    22.186077264509866,
                    22.117647122710693,
                    22.03623720506119,
                    21.830619558423752,
                    21.706916295514034,
                    21.473532563247186,
                    21.23654258023201,
                    20.900618164273595,
                    20.721434994608654,
                    20.734060280782398,
                    21.000302479224978,
                    21.286168862584137,
                    21.695149965095087,
                    21.939022955997288,
                    22.201481658853243,
                    22.458861615381217,
                    22.591974761308474,
                    22.47122103429752,
                    22.259040783903817,
                    22.121398805121213,
                    22.12590491427934,
                    22.181986999010814,
                    22.277283368029607,
                    22.350176443962187,
                    22.439046551408016,
                    22.360488457759242,
                    21.968570579488507,
                    21.457169228881245,
                    20.93123834627345,
                    20.47220830064213,
                    20.14455985521014,
                    19.899268905601602,
                    19.683564209769553,
                    19.800320838440044,
                    19.973800360103528,
                    20.10604924807998,
                    20.157598258199293,
                    20.067882715598508,
                    19.953208145685515,
                    20.185110292893818,
                    20.2358523087793
                ],
                "L95%_1SD": [
                    16.324952557050256,
                    16.400006256003724,
                    16.457415525980814,
                    16.52740801739343,
                    16.465537081787158,
                    16.0517976827419,
                    16.229711297608556,
                    16.3281739762771,
                    16.274279632611968,
                    16.210162651933647,
                    16.048221907400098,
                    15.95079545191619,
                    15.76698663986441,
                    15.580337609860958,
                    15.315769607469491,
                    15.174648179528113,
                    15.184591626874976,
                    15.394279173382422,
                    15.619422373469337,
                    15.941528502606964,
                    16.133598465298256,
                    16.34030619902087,
                    16.543014003870155,
                    16.647851513253155,
                    16.55274805896727,
                    16.385638726251983,
                    16.27723438991392,
                    16.2807833200955,
                    16.324952557050256,
                    16.400006256003724,
                    16.457415525980814,
                    16.52740801739343,
                    16.465537081787158,
                    16.156869639857522,
                    15.754099173279673,
                    15.339885509737126,
                    14.978361737004345,
                    14.7203117395152,
                    14.527125018158596,
                    14.35723989587618,
                    14.449195307706496,
                    14.585824645503774,
                    14.68998148093533,
                    14.730580550203975,
                    14.659922209333942,
                    14.569606589373954,
                    14.752248531794681,
                    14.792212026981051
                ],
                "U95%_1SD": [
                    23.61640077667589,
                    23.404220526282185,
                    23.26657854749958,
                    23.271084656657706,
                    23.32716674138918,
                    22.98033949550607,
                    23.206238041909653,
                    23.331257006888233,
                    23.26282686508906,
                    23.18141694743956,
                    22.97579930080212,
                    22.8520960378924,
                    22.618712305625554,
                    22.381722322610376,
                    22.045797906651963,
                    21.86661473698702,
                    21.879240023160765,
                    22.145482221603345,
                    22.431348604962505,
                    22.840329707473455,
                    23.084202698375655,
                    23.34666140123161,
                    23.604041357759584,
                    23.737154503686842,
                    23.61640077667589,
                    23.404220526282185,
                    23.26657854749958,
                    23.271084656657706,
                    23.32716674138918,
                    23.422463110407975,
                    23.495356186340555,
                    23.584226293786383,
                    23.50566820013761,
                    23.113750321866874,
                    22.602348971259612,
                    22.076418088651817,
                    21.617388043020497,
                    21.289739597588508,
                    21.04444864797997,
                    20.82874395214792,
                    20.94550058081841,
                    21.118980102481895,
                    21.251228990458348,
                    21.30277800057766,
                    21.213062457976875,
                    21.098387888063883,
                    21.330290035272185,
                    21.381032051157668
                ],
                "L95%_2SD": [
                    15.312235783602445,
                    15.382228275015061,
                    15.320357339408789,
                    15.011689897479153,
                    14.608919430901304,
                    14.90661794036353,
                    15.084531555230187,
                    15.18299423389873,
                    15.129099890233599,
                    15.064982909555278,
                    14.903042165021729,
                    14.80561570953782,
                    14.62180689748604,
                    14.435157867482589,
                    14.170589865091122,
                    14.029468437149744,
                    14.039411884496607,
                    14.249099431004053,
                    14.474242631090968,
                    14.796348760228595,
                    14.988418722919887,
                    15.1951264566425,
                    15.397834261491786,
                    15.502671770874786,
                    15.407568316588902,
                    15.240458983873614,
                    15.132054647535552,
                    15.135603577717132,
                    15.179772814671887,
                    15.254826513625355,
                    15.312235783602445,
                    15.382228275015061,
                    15.320357339408789,
                    15.011689897479153,
                    14.608919430901304,
                    14.194705767358757,
                    13.833181994625976,
                    13.57513199713683,
                    13.381945275780227,
                    13.212060153497813,
                    13.304015565328129,
                    13.440644903125406,
                    13.544801738556961,
                    13.585400807825607,
                    13.514742466955573,
                    13.424426846995585,
                    13.607068789416312,
                    13.647032284602682
                ],
                "U95%_2SD": [
                    24.41175828987795,
                    24.416264399036073,
                    24.472346483767552,
                    24.567642852786342,
                    24.640535928718926,
                    24.12551923788444,
                    24.351417784288024,
                    24.476436749266604,
                    24.408006607467428,
                    24.326596689817926,
                    24.12097904318049,
                    23.99727578027077,
                    23.763892048003925,
                    23.526902064988747,
                    23.19097764903033,
                    23.011794479365392,
                    23.024419765539136,
                    23.290661963981712,
                    23.576528347340876,
                    23.985509449851826,
                    24.229382440754023,
                    24.49184114360998,
                    24.74922110013795,
                    24.882334246065213,
                    24.761580519054256,
                    24.549400268660555,
                    24.41175828987795,
                    24.416264399036073,
                    24.472346483767552,
                    24.567642852786342,
                    24.640535928718926,
                    24.729406036164754,
                    24.65084794251598,
                    24.25893006424524,
                    23.747528713637983,
                    23.221597831030188,
                    22.762567785398865,
                    22.434919339966875,
                    22.189628390358337,
                    21.97392369452629,
                    22.09068032319678,
                    22.264159844860266,
                    22.39640873283672,
                    22.447957742956028,
                    22.358242200355242,
                    22.24356763044225,
                    22.475469777650552,
                    22.526211793536035
                ],
                "date_time": [
                    "2008-01-26",
                    "2008-01-27",
                    "2008-01-28",
                    "2008-01-29",
                    "2008-01-30",
                    "2008-11-19",
                    "2008-11-20",
                    "2008-11-21",
                    "2008-11-22",
                    "2008-11-23",
                    "2008-11-24",
                    "2008-11-25",
                    "2008-11-26",
                    "2008-11-27",
                    "2008-11-28",
                    "2008-11-29",
                    "2008-11-30",
                    "2008-12-01",
                    "2008-12-02",
                    "2008-12-03",
                    "2008-12-04",
                    "2008-12-05",
                    "2008-12-06",
                    "2008-12-07",
                    "2008-12-08",
                    "2008-12-09",
                    "2008-12-10",
                    "2008-12-11",
                    "2008-12-12",
                    "2008-12-13",
                    "2008-12-14",
                    "2008-12-15",
                    "2008-12-16",
                    "2008-12-17",
                    "2008-12-18",
                    "2008-12-19",
                    "2008-12-20",
                    "2008-12-21",
                    "2008-12-22",
                    "2008-12-23",
                    "2008-12-24",
                    "2008-12-25",
                    "2008-12-26",
                    "2008-12-27",
                    "2008-12-28",
                    "2008-12-29",
                    "2008-12-30",
                    "2008-12-31"
                ]
            }
        )
