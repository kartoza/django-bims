# Generated by Claude Code on 2025-12-19

from django.db import migrations, connection


def populate_data_sources(apps, schema_editor):
    """Populate DataSource table with initial data based on tenant"""
    DataSource = apps.get_model('bims', 'DataSource')
    SiteSetting = apps.get_model('bims', 'SiteSetting')

    # Get project name from site settings
    try:
        site_setting = SiteSetting.objects.first()
        project_name = site_setting.default_data_source if site_setting and site_setting.default_data_source else None
    except Exception:
        project_name = None

    # Fallback to schema name if no site setting
    if not project_name:
        project_name = connection.schema_name
        if project_name == 'public':
            project_name = 'bims'

    # Define data sources based on project
    if project_name == 'fbis':
        # FBIS-specific data sources
        data_sources = [
            {
                'name': 'fbis',
                'category': 'Primary',
                'description': (
                    'Data not available via GBIF that have been sourced and collated from reputable '
                    'databases, peer-reviewed scientific articles, published reports, theses and other '
                    'unpublished data sources.'
                )
            },
            {
                'name': 'gbif',
                'category': 'External',
                'description': (
                    'Freshwater species occurrence data available for South Africa that are currently '
                    'available via the Global Biodiversity Information Facility (GBIF). GBIF includes '
                    'periodically-updated data from the South African Institute for Aquatic Biodiversity '
                    '(SAIAB), as well as \'Research Grade\' iNaturalist data (i.e. records from non-captive '
                    'individuals, with a picture, locality and date, and with two or more IDs in agreement '
                    'at species level). Invertebrate data includes both aquatic and aerial stages.'
                )
            },
            {
                'name': 'virtual_museum',
                'category': 'External',
                'description': (
                    'Freshwater species occurrence data for South Africa that are currently available at '
                    'Virtual Museum (VM) (<a href=\'https://vmus.adu.org.za/\' target=\'_blank\'>'
                    'https://vmus.adu.org.za/</a>). VM is a platform for citizen scientists to contribute '
                    'to biodiversity data and is managed by The Biodiversity and Development Institute '
                    '(<a href=\'http://thebdi.org/\' target=\'_blank\'>http://thebdi.org/</a>) and '
                    'The FitzPatrick Institute of African Ornithology '
                    '(<a href=\'http://www.fitzpatrick.uct.ac.za/\' target=\'_blank\'>'
                    'http://www.fitzpatrick.uct.ac.za/</a>).'
                )
            },
        ]
    else:
        # For other projects: project name + general GBIF
        data_sources = [
            {
                'name': project_name,
                'category': 'Primary',
                'description': (
                    f'{project_name.upper()} project data - biodiversity occurrence records '
                    'collected and managed by the project.'
                )
            },
            {
                'name': 'gbif',
                'category': 'External',
                'description': (
                    'Global Biodiversity Information Facility (GBIF) - an international network '
                    'and data infrastructure providing access to biodiversity data from around the world.'
                )
            },
        ]

    # Create or update data sources
    for ds_data in data_sources:
        DataSource.objects.update_or_create(
            name=ds_data['name'],
            defaults={
                'category': ds_data['category'],
                'description': ds_data['description']
            }
        )


def reverse_populate_data_sources(apps, schema_editor):
    """Remove the populated data sources"""
    DataSource = apps.get_model('bims', 'DataSource')
    SiteSetting = apps.get_model('bims', 'SiteSetting')

    # Get project name from site settings
    try:
        site_setting = SiteSetting.objects.first()
        project_name = site_setting.default_data_source if site_setting and site_setting.default_data_source else None
    except Exception:
        project_name = None

    # Fallback to schema name if no site setting
    if not project_name:
        project_name = connection.schema_name
        if project_name == 'public':
            project_name = 'bims'

    if project_name == 'fbis':
        # Remove FBIS-specific data sources
        DataSource.objects.filter(
            name__in=['fbis', 'gbif', 'virtual_museum']
        ).delete()
    else:
        # Remove project-specific data sources
        DataSource.objects.filter(
            name__in=[project_name, 'gbif']
        ).delete()


class Migration(migrations.Migration):

    dependencies = [
        ('bims', '0486_sourcereference_metadata_file'),
    ]

    operations = [
        migrations.RunPython(
            populate_data_sources,
            reverse_populate_data_sources
        ),
    ]
