{% extends 'main_base.html' %}
{% load jsonify %}
{% load static %}

{% block subtitle %}
    Climate Data 
{% endblock %}

{% block head %}
    <!-- Custom styles for this template -->
    <link href="{% static "css/sass_dashboard.css" %}" rel="stylesheet">
    <link href="{% static "css/dashboard_buttons.css" %}" rel="stylesheet">
    <link href="{% static "js/libs/openlayers-4.6.4/ol.css" %}"
          rel="stylesheet">
    <link rel="stylesheet"
          href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="{% static 'climate/css/dashboard.css' %}">
    <script type="text/javascript">
        const coordinates = [{{ coord.0 }}, {{ coord.1 }}];
        const siteCode = "{{ site_code }}";
        const siteId = "{{ site_id }}";
        const year = "{{ year }}";
        const availableYears = {{ years }};
        const isPrivateUser = {{ is_private_user|yesno:"true,false" }};
        siteDetailsData = {{ site_details | safe }};
    </script>
    <style>
        .year-container {
            display: flex;
            max-width: 500px;
            align-items: center;
        }
        #update-date {
            margin-left: 10px;
        }
        #ui-datepicker-div {
            top: 100px !important;
        }
    </style>

{% endblock %}

{% block body_content %}
    <div style="padding-bottom: 0.2em">
        <div class="body-form container">
            <div class="logo hide-logo pull-right"><img width="50"
                                                        src="{% static 'img/bims-stamp.png' %}"></div>
            <div class="dashboard-title">
                <h2>Climate data for {{ site_code }}</h2>
                <div class="dashboard-close"><i class="fa fa-times"
                                                aria-hidden="true"></i></div>
                <div class="form-group year-container">
                    <label for="year-select" style="margin-right: 5px; margin-top:5px;">Year:</label>&nbsp;
                    <select id="year-select" class="form-control form-control-sm">
                        {% for y in years %}
                            <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                    &nbsp;or&nbsp;
                    <input type="text" name="date"
                           class="form-control form-control-sm date-input"
                           id="startDate" placeholder="Date start" value="{{ start_date|date:"Y-m-d" }}">
                    <span>&nbsp;to&nbsp;</span>
                    <input type="text" name="date" id="endDate"
                           class="form-control form-control-sm date-input" placeholder="Date end" value="{{ end_date|date:"Y-m-d" }}">
                    <button class="btn btn-sm btn-primary" id="update-date"><i class="fa fa-arrow-right" aria-hidden="true"></i></button>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="map-container">
                        <div class="chart-title">Map
                            <i data-download-title="Climate map"
                               data-toggle="tooltip" data-placement="left"
                               title="Download map as PNG"
                               class="fa fa-download pull-right download-icon download-map"></i>
                        </div>
                        <div id="map"></div>
                    </div>
                </div>
                <div class="col-md-6 mp">
                    <div class="table-container">
                        <div class="table-title">
                            Overview
                            <i data-download-title="Overview"
                               data-toggle="tooltip" data-placement="left"
                               class="fa fa-download pull-right download-icon download-table"></i>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered table-sm">
                                <thead>
                                <tr>
                                    <th colspan="2">Site details</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for key, value in site_overview.items %}
                                    <tr>
                                        <td>{{ key }}</td>
                                        <td>{{ value }}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="vertical-space"></div>
                    <div class="table-container">
                        <div class="table-title">
                            Summary statistics
                            <i data-download-title="Summary statistics"
                               data-toggle="tooltip" data-placement="left"
                               class="fa fa-download pull-right download-icon download-table"></i>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead>
                                <tr>
                                    <th></th>
                                    <th>Average over record period</th>
                                    <th>Average for (date range selected)</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr><td>Average Temperature</td>
                                    <td>{{ stats_overall.avg_temp|floatformat:1|default:"--" }} °C</td>
                                    <td>{{ stats.avg_temp|floatformat:1|default:"--" }} °C</td>
                                </tr>
                                <tr><td>Min Temperature</td>
                                    <td>{{ stats_overall.min_temp|floatformat:1|default:"--" }} °C</td>
                                    <td>{{ stats.min_temp|floatformat:1|default:"--" }} °C</td>
                                </tr>
                                <tr><td>Max Temperature</td>
                                    <td>{{ stats_overall.max_temp|floatformat:1|default:"--" }} °C</td>
                                    <td>{{ stats.max_temp|floatformat:1|default:"--" }} °C</td>
                                </tr>
                                <tr><td>Average Humidity</td>
                                    <td>{{ stats_overall.avg_humidity|floatformat:1|default:"--" }} %</td>
                                    <td>{{ stats.avg_humidity|floatformat:1|default:"--" }} %</td>
                                </tr>
                                <tr><td>Average Wind Speed</td>
                                    <td>{{ stats_overall.avg_windspeed|floatformat:2|default:"--" }} m/s</td>
                                    <td>{{ stats.avg_windspeed|floatformat:2|default:"--" }} m/s</td>
                                </tr>
                                <tr><td>Total Rainfall</td>
                                    <td>{{ stats_overall.total_rainfall|floatformat:2|default:"--" }} mm</td>
                                    <td>{{ stats.total_rainfall|floatformat:2|default:"--" }} mm</td>
                                </tr>
                                <tr><td>Maximum Daily Rainfall</td>
                                    <td>{{ stats_overall.max_rainfall|floatformat:2|default:"--" }} mm</td>
                                    <td>{{ stats.max_rainfall|floatformat:2|default:"--" }} mm</td>
                                </tr>
                                <tr><td>Total days on records</td>
                                    <td>{{ total_overall_records }}</td>
                                    <td>{{ total_records }}</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="vertical-space"></div>

            <div class="form-group" style="max-width: 250px;">
                <label for="granularity-select">Display graphs as:</label>
                <select id="granularity-select" class="form-control form-control-sm">
                    <option value="daily">Daily averages</option>
                    <option value="monthly" selected>Monthly averages</option>
                    <option value="annual">Annual averages</option>
                </select>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="chart-container">
                        <div class="chart-title">
                            Temperature overview
                        </div>
                        <div class="chart-body">
                            {% if availability.temperature %}
                                <div id="temperature-chart" style="height: 400px;"></div>
                            {% else %}
                                <div class="alert alert-info">Temperature data is not available for this station.</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-container">
                        <div class="chart-title">
                            Humidity overview
                        </div>
                        <div class="chart-body">
                            {% if availability.humidity %}
                                <div id="humidity-chart" style="height: 400px;"></div>
                            {% else %}
                                <div class="alert alert-info">Humidity data is not available for the selected period.</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="vertical-space"></div>

            <div class="chart-container">
                <div class="chart-title">
                    <span id="rainfall-chart-title">Monthly total rainfall</span>
                </div>
                <div class="chart-body">
                    {% if availability.rainfall %}
                        <div id="rainfall-chart" style="height: 300px;"></div>
                    {% else %}
                        <div class="alert alert-info">Rainfall data is not available for the selected period.</div>
                    {% endif %}
                </div>
            </div>

            <div class="vertical-space"></div>
            <div class="table-container">
                <div class="table-title">
                    Monthly Climate Summary
                    {% if is_private_user %}
                    <i data-download-title="Daily Climate Records (Raw Data)"
                       data-toggle="tooltip" data-placement="left"
                       title="Download daily raw data (CSV)"
                       class="fa fa-download pull-right download-icon download-daily-csv"
                       style="margin-left: 10px;">&nbsp;Daily CSV</i>
                    {% endif %}
                    <i data-download-title="Monthly Climate Summary"
                       data-toggle="tooltip" data-placement="left"
                       title="Download monthly summary"
                       class="fa fa-download pull-right download-icon download-table"></i>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered table-sm">
                        <thead>
                        <tr>
                            <th>Period</th>
                            <th>Avg Temp (°C)</th>
                            <th>Min Temp (°C)</th>
                            <th>Max Temp (°C)</th>
                            <th>Avg Humidity (%)</th>
                            <th>Avg Wind (m/s)</th>
                            <th>Total Rain (mm)</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for record in climate_records %}
                            <tr>
                                <td>{{ record.period_formatted }}</td>
                                <td>{{ record.avg_temperature|floatformat:1|default:"--" }}</td>
                                <td>{{ record.min_temperature|floatformat:1|default:"--" }}</td>
                                <td>{{ record.max_temperature|floatformat:1|default:"--" }}</td>
                                <td>{{ record.avg_humidity|floatformat:1|default:"--" }}</td>
                                <td>{{ record.avg_windspeed|floatformat:2|default:"--" }}</td>
                                <td>{{ record.total_rainfall|floatformat:2|default:"--" }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="vertical-space"></div>
            <p class="text-muted text-center">
                <small>Page generated in {{ execution_time|floatformat:2 }} seconds</small>
            </p>
        </div>
    </div>
{% endblock %}

{% block extra_foot %}

    <script src="{% static "js/libs/bootstrap-4.0.0/js/bootstrap.bundle.min.js" %}"></script>
    <script src="{% static "js/libs/jquery-ui-1.12.1/jquery-ui.min.js" %}"></script>
    <script src="{% static "js/libs/highcharts/highstock.js" %}"></script>
    <script src="{% static "js/libs/highcharts/modules/exporting.js" %}"></script>
    <script src="{% static "js/libs/highcharts/modules/offline-exporting.js" %}"></script>
    <script src="{% static "js/libs/highcharts/modules/export-data.js" %}"></script>
    <script src="{% static "js/libs/openlayers-4.6.4/ol.js" %}"></script>
    <script src="{% static "js/libs/htmlToCanvas/html2canvas.js" %}"></script>
    <script src="{% static "js/utils/table_download.js" %}"></script>
    <script src="{% static "js/utils/svg_download.js" %}"></script>
    <script src="{% static "js/utils/download_csv.js" %}"></script>
    <script src="{% static "js/map-dashboard.js" %}"></script>
    <script src="{% static "js/sass_dashboard_close.js" %}"></script>
    <script src="{% static "js/non_requirejs/download_request_popup.js" %}"></script>
    <script id="climate-dashboard-data" type="application/json">
        {{ chart_payload|default:'{}'|safe }}
    </script>
    {% if is_private_user and daily_records_json %}
    <script id="daily-records-data" type="application/json">
        {{ daily_records_json|safe }}
    </script>
    {% endif %}
    <script src="{% static 'climate/js/dashboard.js' %}"></script>
    <script>
        $(document).ready(function() {
            if (typeof $.fn.datepicker === 'function') {
                $('.date-input').datepicker({
                    dateFormat: 'yy-mm-dd',
                    changeMonth: true,
                    changeYear: true
                });
            } else {
                // Fallback to HTML5 date input
                $('.date-input').attr('type', 'date');
            }
            $('#year-select').change(function() {
                const selectedYear = $(this).val();
                window.location.href = `/climate/${siteId}/${selectedYear}/?siteId=${siteId}`;
            });
            $('#update-date').click(function() {
                const startDate = $('#startDate').val();
                const endDate = $('#endDate').val();
                window.location.href = `/climate/${siteId}/?siteId=${siteId}&startDate=${startDate}&endDate=${endDate}`;
            });
            $('.dashboard-close').click(function() {
                window.history.back();
            });
            let map = null;
            map = createDashboardMap(map, coordinates);

            // Daily CSV download for private users
            $('.download-daily-csv').click(function() {
                const dailyDataEl = document.getElementById('daily-records-data');
                if (!dailyDataEl) return;

                const title = $(this).data('downloadTitle') || 'Daily Climate Records';

                if (typeof showDownloadPopup === 'function') {
                    showDownloadPopup('CSV', title, function() {
                        const dailyRecords = JSON.parse(dailyDataEl.textContent);
                        if (!dailyRecords || !dailyRecords.length) return;

                        // Build CSV content
                        const headers = ['Date', 'Avg Temp (°C)', 'Min Temp (°C)', 'Max Temp (°C)', 'Avg Humidity (%)', 'Min Humidity (%)', 'Max Humidity (%)', 'Avg Wind (m/s)', 'Daily Rainfall (mm)'];
                        let csvContent = headers.join(',') + '\n';

                        dailyRecords.forEach(function(record) {
                            const row = [
                                record.date,
                                record.avg_temperature !== null ? record.avg_temperature : '',
                                record.min_temperature !== null ? record.min_temperature : '',
                                record.max_temperature !== null ? record.max_temperature : '',
                                record.avg_humidity !== null ? record.avg_humidity : '',
                                record.min_humidity !== null ? record.min_humidity : '',
                                record.max_humidity !== null ? record.max_humidity : '',
                                record.avg_windspeed !== null ? record.avg_windspeed : '',
                                record.daily_rainfall !== null ? record.daily_rainfall : ''
                            ];
                            csvContent += row.join(',') + '\n';
                        });

                        // Download
                        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = 'daily_climate_records_' + siteCode + '.csv';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    }, true, null, false);
                }
            });
        });
    </script>

{% endblock %}
