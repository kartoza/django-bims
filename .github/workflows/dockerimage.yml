name: Test Django App

on: 
  pull_request:

jobs:
  tests:
    runs-on: ubuntu-latest
    container: python:3.7-slim-stretch
    # Service containers to run with `container-job`
    services:
      # Label used to access the service container
      db:
        # Docker Hub image
        image: kartoza/postgis:9.6-2.4
        # Provide the password for postgres
        env:
          POSTGRES_USER: docker
          POSTGRES_PASS: docker
          POSTGRES_DBNAME: gis
          POSTGRES_PASSWORD: docker
          ALLOW_IP_RANGE: 0.0.0.0/0
        # Set health checks to wait until postgres has started
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
     - name: Set up Python 3.7.10
       uses: actions/setup-python@v1
       with:
        python-version: 3.7.10
     - name: Install system dependencies
       run: |
         sudo apt-get update
         sudo apt-get install -y gcc make libc-dev musl-dev libpcre3 libpcre3-dev g++
         sudo apt-get install -y libgeos-dev libgdal-dev
         sudo apt-get install -y libxml2-dev libxslt-dev
         sudo apt-get install -y geoip-bin geoip-database
         sudo apt-get install -y curl
     - uses: actions/checkout@v2
       with:
        path: bims
     - name: Checkout tools repo
       uses: actions/checkout@v2
       with:
        repository: GeoNode/geonode
        fetch-depth: 1
        ref: 3.1.x
        path: geonode
     - name: Install dependencies
       run: |
        pwd
        mv geonode/geonode bims/
        pip3 install -r geonode/requirements.txt
        pip3 install -r bims/deployment/docker/REQUIREMENTS.txt
        pip3 install kombu==4.6.8
        pip3 install uwsgi
        pip3 install celery==4.4.0
        pip3 install pygdal==$(gdal-config --version).*
     - name: set pythonpath
       run: |
        echo "PYTHONPATH=/home/runner/work/django-bims/django-bims/bims/geonode;/home/runner/work/django-bims/django-bims/bims" >> $GITHUB_ENV
        echo "DJANGO_SETTINGS_MODULE=core.settings.test_docker" >> $GITHUB_ENV
     - name: Use the value
       run: |
        echo "${{ env.PYTHONPATH }}"
        echo "${{ env.DJANGO_SETTINGS_MODULE }}"
     - name: Run tests
       env:
         DJANGO_SETTINGS_MODULE: core.settings.test_docker
         PYTHONPATH: /home/runner/work/django-bims/django-bims/bims/geonode;/home/runner/work/django-bims/django-bims/bims
       working-directory: bims
       run: python manage.py test bims --noinput --settings=core.settings.test_docker
